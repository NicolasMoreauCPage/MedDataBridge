{% extends "base.html" %}
{% import "macros/ui.html" as ui %}

{% block content %}
<div class="max-w-content mx-auto px-4 py-8">
  <!-- Dashboard Header -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-8 gap-4">
    <div>
      <h1 class="text-3xl font-bold text-primary mb-1">{{ summary.ej.name }}</h1>
      <p class="text-slate-600">FINESS : <span class="font-mono">{{ summary.ej.finess_ej or 'N/A' }}</span></p>
      {% if summary.ej.strict_pam_fr %}
        <span class="inline-flex items-center px-3 py-1 mt-2 rounded-full text-sm font-medium bg-purple-100 text-purple-800">
          üîí Mode strict IHE PAM France
        </span>
      {% endif %}
    </div>
    <div class="flex gap-2">
      <a href="/conformity" class="px-4 py-2 rounded-lg bg-slate-100 text-slate-700 hover:bg-slate-200 transition">‚Üê Liste des EJ</a>
      <a href="/conformity/ej/{{ summary.ej.id }}/messages" class="px-4 py-2 rounded-lg bg-primary text-white hover:bg-blue-700 transition">Voir tous les messages</a>
    </div>
  </div>

  <!-- Metrics Cards -->
  <div class="grid gap-6 md:grid-cols-3 mb-8">
    {{ ui.metric_card('Tous messages (7j)', summary.conformity_7d.total, 'total', summary.conformity_7d.rate) }}
    {{ ui.metric_card('Messages entrants (7j)', summary.conformity_inbound_7d.total, 'total', summary.conformity_inbound_7d.rate) }}
    {{ ui.metric_card('Messages sortants (7j)', summary.conformity_outbound_7d.total, 'total', summary.conformity_outbound_7d.rate) }}
  </div>

  <!-- Issues r√©currentes -->
  {% if summary.recurring_issues %}
  <section class="bg-white rounded-lg shadow mb-8" aria-labelledby="issues-heading">
    <div class="px-6 py-4 border-b border-slate-200">
      <h2 id="issues-heading" class="text-xl font-semibold text-slate-900">‚ö†Ô∏è Issues r√©currentes (7 derniers jours)</h2>
      <p class="text-sm text-slate-600 mt-1">Probl√®mes de validation les plus fr√©quents √† corriger</p>
    </div>
    <ul class="divide-y divide-slate-200" role="list">
      {% for issue in summary.recurring_issues %}
      <li class="px-6 py-4 flex items-center justify-between hover:bg-slate-50" role="listitem">
        <div class="flex-1">
          <div class="flex items-center space-x-2">
            {% set sev = issue.severity %}
            {% set sev_color = 'blue' %}
            {% if sev == 'error' %}{% set sev_color='red' %}{% elif sev in ['warn','warning'] %}{% set sev_color='yellow' %}{% endif %}
            <span class="px-2 py-1 rounded text-xs font-semibold bg-{{ sev_color }}-100 text-{{ sev_color }}-800" aria-label="S√©v√©rit√© {{ sev }}">{{ sev|upper }}</span>
            <code class="text-sm font-mono text-slate-700" aria-label="Code validation">{{ issue.code }}</code>
          </div>
          <p class="mt-1 text-sm text-slate-600" aria-label="Description de l'erreur">{{ issue.message }}</p>
        </div>
        <div class="ml-4 flex-shrink-0">
          <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold bg-slate-100 text-slate-800" aria-label="Occurrences">{{ issue.count }} occurrence{% if issue.count>1 %}s{% endif %}</span>
        </div>
      </li>
      {% endfor %}
    </ul>
  </section>
  {% endif %}

  <!-- Timeline 30 jours -->
  {% if summary.timeline_30d %}
  <section class="bg-white rounded-lg shadow" aria-labelledby="evolution-heading">
    <div class="px-6 py-4 border-b border-slate-200">
      <h2 id="evolution-heading" class="text-xl font-semibold text-slate-900">üìà √âvolution (30 derniers jours)</h2>
    </div>
    <div class="p-6">
      <div class="space-y-2" role="list">
        {% for day in summary.timeline_30d %}
        <div class="flex items-center space-x-4" role="listitem" aria-label="Jour {{ day.date }}">
          <span class="text-xs text-slate-500 w-20" aria-label="Date">{{ day.date }}</span>
          <div class="flex-1" aria-label="Barre de conformit√©">
            <div class="flex items-center space-x-2">
              {{ ui.progress_bar(day.rate) }}
              <span class="text-xs font-medium text-slate-700 w-12 text-right" aria-label="Taux">{{ day.rate }}%</span>
            </div>
          </div>
          <span class="text-xs text-slate-500 w-16 text-right" aria-label="Total messages">{{ day.total }} msg</span>
        </div>
        {% endfor %}
      </div>
    </div>
  </section>
  {% endif %}
</div>
{% endblock %}
