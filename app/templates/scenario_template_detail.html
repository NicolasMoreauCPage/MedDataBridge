{% extends "base.html" %}

{% block title %}{{ template.name }}{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <!-- En-t√™te -->
  <div class="mb-6">
    <nav class="text-sm breadcrumbs mb-4">
      <ul class="flex gap-2 text-slate-600">
        {% for crumb in breadcrumbs %}
          <li>
            <a href="{{ crumb.url }}" class="hover:text-blue-600">{{ crumb.label }}</a>
            {% if not loop.last %}<span class="mx-2">/</span>{% endif %}
          </li>
        {% endfor %}
      </ul>
    </nav>
    
    <div class="flex items-start justify-between">
      <div>
        <h1 class="text-3xl font-bold text-slate-900">{{ template.name }}</h1>
        {% if template.description %}
          <p class="mt-2 text-slate-600">{{ template.description }}</p>
        {% endif %}
        <div class="mt-3 flex gap-3">
          <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
            {{ template.category }}
          </span>
          <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
            {{ template.protocols_supported }}
          </span>
          {% if template.tags %}
            {% for tag in template.tags.split(',') %}
              <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-slate-100 text-slate-700">
                {{ tag.strip() }}
              </span>
            {% endfor %}
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- √âtapes du template -->
  <div class="bg-white shadow rounded-lg p-6 mb-6">
    <h2 class="text-xl font-semibold text-slate-900 mb-4">√âtapes du sc√©nario ({{ steps|length }})</h2>
    <div class="space-y-3">
      {% for step in steps %}
        <div class="border border-slate-200 rounded-lg p-4 hover:bg-slate-50 transition">
          <div class="flex items-start gap-4">
            <div class="flex-shrink-0 w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center font-semibold text-sm">
              {{ step.order_index }}
            </div>
            <div class="flex-1">
              <h3 class="font-medium text-slate-900">{{ step.semantic_event_code }}</h3>
              {% if step.narrative %}
                <p class="text-sm text-slate-600 mt-1">{{ step.narrative }}</p>
              {% endif %}
              <div class="mt-2 flex gap-3 text-xs">
                {% if step.hl7_event_code %}
                  <span class="inline-flex items-center px-2 py-1 rounded bg-green-100 text-green-800">
                    HL7: {{ step.hl7_event_code }}
                  </span>
                {% endif %}
                {% if step.message_role %}
                  <span class="inline-flex items-center px-2 py-1 rounded bg-amber-100 text-amber-800">
                    {{ step.message_role }}
                  </span>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>

  <!-- Formulaire de rejeu -->
  <div class="bg-white shadow rounded-lg p-6">
    <h2 class="text-xl font-semibold text-slate-900 mb-4">üé¨ Rejouer ce template</h2>
    <form id="playForm" class="space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-2">Protocole</label>
          <select name="protocol" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
            <option value="HL7v2">HL7 v2.5 (ADT)</option>
            <option value="FHIR">FHIR R4 (Bundle)</option>
          </select>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-2">Endpoint cible</label>
          <select name="endpoint_id" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
            <option value="">-- S√©lectionner un endpoint --</option>
            {% for ep in endpoints %}
              <option value="{{ ep.id }}">{{ ep.name }} ({{ ep.kind }})</option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-slate-700 mb-2">Pr√©fixe IPP (optionnel)</label>
          <input type="text" name="ipp_prefix" placeholder="Ex: 9" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
        </div>

        <div>
          <label class="block text-sm font-medium text-slate-700 mb-2">Pr√©fixe NDA (optionnel)</label>
          <input type="text" name="nda_prefix" placeholder="Ex: 5" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
        </div>

        <div class="md:col-span-2">
          <label class="flex items-center gap-2">
            <input type="checkbox" name="dry_run" checked class="rounded border-slate-300 text-blue-600 focus:ring-blue-500">
            <span class="text-sm text-slate-700">Dry-run (simulation sans envoi r√©el)</span>
          </label>
        </div>
      </div>

      <div class="flex gap-3">
        <button type="button" onclick="materializeOnly()" class="px-4 py-2 bg-slate-600 hover:bg-slate-700 text-white rounded-lg font-medium transition">
          üì¶ Mat√©rialiser seulement
        </button>
        <button type="submit" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition">
          ‚ñ∂Ô∏è Rejouer maintenant
        </button>
      </div>
    </form>

    <!-- R√©sultats -->
    <div id="results" class="mt-6 hidden">
      <h3 class="font-semibold text-slate-900 mb-3">R√©sultat</h3>
      <pre id="resultContent" class="bg-slate-50 border border-slate-200 rounded p-4 text-xs overflow-x-auto"></pre>
    </div>
  </div>
</div>

<script>
async function materializeOnly() {
  const form = document.getElementById('playForm');
  const formData = new FormData(form);
  const protocol = formData.get('protocol');
  const ipp_prefix = formData.get('ipp_prefix');
  const nda_prefix = formData.get('nda_prefix');
  
  const payload = { protocol, ipp_prefix, nda_prefix };
  
  try {
    const response = await fetch(`/scenarios/templates/{{ template.key }}/materialize`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const data = await response.json();
    document.getElementById('results').classList.remove('hidden');
    document.getElementById('resultContent').textContent = JSON.stringify(data, null, 2);
  } catch (error) {
    alert('Erreur: ' + error.message);
  }
}

document.getElementById('playForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const formData = new FormData(e.target);
  
  try {
    const response = await fetch(`/scenarios/templates/{{ template.key }}/play`, {
      method: 'POST',
      body: formData
    });
    const data = await response.json();
    document.getElementById('results').classList.remove('hidden');
    document.getElementById('resultContent').textContent = JSON.stringify(data, null, 2);
  } catch (error) {
    alert('Erreur: ' + error.message);
  }
});
</script>
{% endblock %}
