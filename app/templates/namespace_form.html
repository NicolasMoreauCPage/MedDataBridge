{% extends "base.html" %}
{% import "components.html" as components %}

{% block content %}
<div class="container">
    <div class="my-8">
        <h1 class="text-3xl font-bold mb-6">
            {% if namespace %}Modifier{% else %}Nouvel{% endif %} espace de noms
        </h1>

        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
            <form method="POST" action="{% if namespace %}/admin/ght/{{ context.id }}/namespaces/{{ namespace.id }}/edit{% else %}/admin/ght/{{ context.id }}/namespaces/new{% endif %}">
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-slate-700">Nom</label>
                        <input type="text" name="name" value="{{ namespace.name if namespace else '' }}" required
                               class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <p class="mt-1 text-sm text-slate-500">Nom descriptif (ex: "IPP EJ Principal")</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700">URI du syst√®me</label>
                        <input type="text" name="system" value="{{ namespace.system if namespace else '' }}" required
                               pattern="[a-zA-Z][a-zA-Z0-9\-\._:]+[a-zA-Z0-9]+"
                               class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <p class="mt-1 text-sm text-slate-500">URI unique (ex: "urn:oid:1.2.250.1.71.1.2.2")</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700">OID</label>
                        <input type="text" name="oid" value="{{ namespace.oid if namespace else '' }}"
                               pattern="[0-9]+(\.[0-9]+)*"
                               class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <p class="mt-1 text-sm text-slate-500">OID si diff√©rent de l'URI (ex: "1.2.250.1.71.1.2.2")</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700">Type</label>
                        <select name="type" required
                                class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="PI" {% if not namespace or namespace.type == 'PI' %}selected{% endif %}>Patient Interne (PI)</option>
                            <option value="VN" {% if namespace and namespace.type == 'VN' %}selected{% endif %}>Visite/Venue (VN)</option>
                            <option value="XX" {% if namespace and namespace.type == 'XX' %}selected{% endif %}>Organisation (XX)</option>
                            <option value="RI" {% if namespace and namespace.type == 'RI' %}selected{% endif %}>Resource ID (RI)</option>
                        </select>
                        <p class="mt-1 text-sm text-slate-500">Type d'identifiant selon HL7</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700">Description</label>
                        <textarea name="description" rows="3"
                                  class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">{{ namespace.description if namespace else '' }}</textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700">√âtat</label>
                        <select name="is_active"
                                class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="true" {% if not namespace or namespace.is_active %}selected{% endif %}>Actif</option>
                            <option value="false" {% if namespace and not namespace.is_active %}selected{% endif %}>Inactif</option>
                        </select>
                    </div>

                    <!-- Configuration des pr√©fixes pour g√©n√©ration d'identifiants de test -->
                    <div class="border-t border-slate-200 pt-6 mt-6">
                        <h3 class="text-lg font-semibold text-slate-900 mb-4">
                            Configuration des pr√©fixes (pour sc√©narios de test)
                        </h3>
                        <p class="text-sm text-slate-600 mb-4">
                            Configurez des pr√©fixes d'identifiants pour √©viter les collisions avec les donn√©es du syst√®me r√©cepteur lors des tests.
                        </p>

                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700">Mode de g√©n√©ration</label>
                                <select name="prefix_mode" id="prefix_mode"
                                        onchange="togglePrefixMode()"
                                        class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                    <option value="fixed" {% if not namespace or namespace.prefix_mode == 'fixed' %}selected{% endif %}>Pr√©fixe fixe + s√©quence</option>
                                    <option value="range" {% if namespace and namespace.prefix_mode == 'range' %}selected{% endif %}>Plage num√©rique (min-max)</option>
                                </select>
                            </div>

                            <div id="pattern_field">
                                <label class="block text-sm font-medium text-slate-700">Pattern de pr√©fixe</label>
                                <input type="text" name="prefix_pattern" id="prefix_pattern"
                                       value="{{ namespace.prefix_pattern if namespace else '' }}"
                                       placeholder="ex: 9..., 91...., 501..."
                                       pattern="[0-9]*\.+"
                                       class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <p class="mt-1 text-sm text-slate-500">
                                    Les '.' repr√©sentent des chiffres g√©n√©r√©s al√©atoirement.<br>
                                    Exemples: "9..." ‚Üí 9001-9999, "91...." ‚Üí 91000-91999, "501..." ‚Üí 501000-501999
                                </p>
                            </div>

                            <div id="range_fields" style="display: none;">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700">Valeur minimale</label>
                                        <input type="number" name="prefix_min" id="prefix_min"
                                               value="{{ namespace.prefix_min if namespace else '' }}"
                                               placeholder="ex: 9000000"
                                               class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700">Valeur maximale</label>
                                        <input type="number" name="prefix_max" id="prefix_max"
                                               value="{{ namespace.prefix_max if namespace else '' }}"
                                               placeholder="ex: 9999999"
                                               class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                    </div>
                                </div>
                                <p class="mt-1 text-sm text-slate-500">
                                    Plage num√©rique compl√®te (ex: 9000000 - 9999999)
                                </p>
                            </div>

                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <h4 class="text-sm font-semibold text-blue-900 mb-2">üí° Conseils</h4>
                                <ul class="text-sm text-blue-800 space-y-1">
                                    <li>‚Ä¢ Utilisez des pr√©fixes r√©serv√©s pour tests (ex: plage 9xxxxx)</li>
                                    <li>‚Ä¢ Coordonnez avec l'√©quipe du syst√®me r√©cepteur</li>
                                    <li>‚Ä¢ Un pr√©fixe court (9...) g√©n√®re plus de collisions qu'un long (91....)</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end gap-4">
                        <a href="/admin/ght/{{ context.id }}" 
                           class="px-4 py-2 text-slate-600 hover:text-slate-800">
                            Annuler
                        </a>
                        <button type="submit" 
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            {% if namespace %}Mettre √† jour{% else %}Cr√©er{% endif %}
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function togglePrefixMode() {
    const mode = document.getElementById('prefix_mode').value;
    const patternField = document.getElementById('pattern_field');
    const rangeFields = document.getElementById('range_fields');
    
    if (mode === 'range') {
        patternField.style.display = 'none';
        rangeFields.style.display = 'block';
        document.getElementById('prefix_pattern').required = false;
    } else {
        patternField.style.display = 'block';
        rangeFields.style.display = 'none';
        document.getElementById('prefix_pattern').required = false;
    }
}

// Initialiser l'affichage au chargement
document.addEventListener('DOMContentLoaded', togglePrefixMode);
</script>
{% endblock %}