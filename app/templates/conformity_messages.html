{% extends "base.html" %}

{% block content %}
<div class="max-w-content mx-auto py-8 px-4">
  <!-- Navigation -->
  <nav class="mb-6 flex items-center space-x-2 text-sm">
    <a href="/conformity" class="text-blue-600 hover:text-blue-700">Conformité</a>
    <span class="text-slate-400">→</span>
    <a href="/conformity/ej/{{ ej.id }}" class="text-blue-600 hover:text-blue-700">{{ ej.name }}</a>
    <span class="text-slate-400">→</span>
    <span class="text-slate-900">Messages</span>
  </nav>

  <!-- En-tête -->
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-slate-900">Messages - {{ ej.name }}</h1>
    <p class="mt-2 text-slate-600">Liste des messages HL7 des 30 derniers jours</p>
  </div>

  <!-- Liste des messages -->
  <div class="bg-white rounded-lg shadow overflow-hidden">
    <table class="min-w-full divide-y divide-slate-200">
      <thead class="bg-slate-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
            ID
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
            Date
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
            Direction
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
            Type
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
            Endpoint
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
            Statut
          </th>
          <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">
            Actions
          </th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-slate-200">
        {% for msg in messages %}
        <tr class="hover:bg-slate-50">
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">
            #{{ msg.log.id }}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">
            {{ msg.log.created_at.strftime('%Y-%m-%d %H:%M') if msg.log.created_at else 'N/A' }}
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="px-2 py-1 rounded text-xs font-medium
                         {% if msg.log.direction == 'inbound' %}bg-blue-100 text-blue-800
                         {% else %}bg-green-100 text-green-800{% endif %}">
              {{ msg.log.direction or 'N/A' }}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">
            <code>{{ msg.log.message_type or 'N/A' }}</code>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">
            {{ msg.log.endpoint_id or '-' }}
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            {% if msg.is_valid %}
            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-800">
              ✓ Valide
            </span>
            {% else %}
            <div class="space-y-1">
              <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-800">
                ✗ {{ msg.error_count }} erreur(s)
              </span>
              {% if msg.warn_count > 0 %}
              <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-yellow-100 text-yellow-800">
                ⚠ {{ msg.warn_count }} warning(s)
              </span>
              {% endif %}
            </div>
            {% endif %}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
            <a href="/conformity/ej/{{ ej.id }}/messages/{{ msg.log.id }}" 
               class="text-blue-600 hover:text-blue-900">
              Détail →
            </a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    {% if not messages %}
    <div class="text-center py-12 text-slate-500">
      Aucun message trouvé pour les 30 derniers jours
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}
